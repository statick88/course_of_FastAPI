# Laboratorio de CNN con FastAPI

En este laboratorio, vamos a utilizar el modelo de clasificación de imágenes de CIFAR-10 que creamos en el laboratorio anterior, y vamos a crear una API REST con FastAPI para poder hacer predicciones con el modelo.

## 1. Cargar el modelo creado en el laboratorio anterior

Crear el archivo **main,py** con el siguiente contenido:

```python
from fastapi import FastAPI, File, UploadFile
import tensorflow as tf
import numpy as np
from PIL import Image
import io

app = FastAPI()

# Cargar el modelo
model = tf.keras.models.load_model('cifar10_model.keras')

@app.post("/predict/")
async def predict(file: UploadFile = File(...)):
    try:
        image = Image.open(io.BytesIO(await file.read()))
        image = image.convert("RGB")  # Asegúrate de que la imagen esté en formato RGB
        image = image.resize((32, 32))  # Ajustar tamaño de imagen
        image = np.array(image) / 255.0  # Normalizar
        image = np.expand_dims(image, axis=0)  # Añadir dimensión del batch

        predictions = model.predict(image)
        class_idx = np.argmax(predictions, axis=1)[0]
        return {"class_idx": int(class_idx), "confidence": float(np.max(predictions))}
    except Exception as e:
        return {"error": str(e)}

@app.get("/")
def read_root():
    return {"message": "Welcome to pyDay Piura 2024"}
```

## 2. Ejecutar la API

Para ejecutar la API, ejecuta el siguiente comando:

```bash
uvicorn main:app --reload
```

## 3. Probar la API

Para probar la API vamos a utilizar la herramienta **curl**. Ejecuta el siguiente comando en una terminal:

```bash
curl -X POST "http://127.0.0.1:8000/predict/" -H "accept: application/json" -H "Content-Type: multipart/form-data" -F "file=@<ruta de la imagen>"
```

Por ejemplo:

```bash
curl -X POST "http://127.0.0.1:8000/predict/" -F "file=@/home/statick/workspaces/charlas/practica/img_example/aeroplano.jpg"
```

En el caso de que la imagen sea un **avión**, deberías obtener una respuesta similar a la siguiente:

```json
{"class_idx": 0, "confidence": 0.9999998807907104}
```

:::{.callout-tip}
Recuerda la lista de clases de CIFAR-10:

0. Avión
1. Automóvil
2. Pájaro
3. Gato
4. Ciervo
5. Perro
6. Rana
7. Caballo
8. Barco
9. Camión
:::

